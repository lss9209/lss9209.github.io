---
title: "ElasticSearch의 개념"
date: 2021-03-06 13:51:47 -0400
categories: ElasticSearch
---
# 엘라스틱서치의 개념
---

![Alt text](https://gblobscdn.gitbook.com/assets%2F-Ln04DaYZaDjdiR_ZsKo%2F-LnUxLhQtL_hJwYydM_5%2F-LnKl_15PVn3pJ-V-jG6%2Fimage.png?alt=media&token=a3fdac30-9030-44f8-b2a1-08811e09b2d9)

##노드의 종류

1.마스터노드:마스터노드는 오직 한 대이고 모든 클러스터의 메타정보를 관리한다. 다만 여러대를 마스터노드로 지정해 놓으면 그 노드들은 현재 작동하고 있는 마스터노드가 고장났을때 대체 될 수 있다. 다만 이 떄 주의해야 하는 것 중 하나가 설정에서 클러스터 구축에 요구되는 최소 마스터노드들의 갯수를 전체 마스터 노드 갯수의 과반수로 구성해야 한다는 것이다. 그 이유는 과반수 미만으로도 클러스터가 구축가능하게 할 경우 마스터노드간의 통신이 끊어졌을때 끊어진 마스터노드들이 별도의 클러스터를 구축하는 현상(Split Brain)이 발생할 수 있기 때문이다.<br>
2.데이터노드:데이터를 저장하고 저장된 데이터를 내어주는 노드다.<br>
3.인제스트노드:문서 저장전 문서내용을 사전처리하는 노드다.<br>
4.코디네이트: 사용자의 요청을 데이터노드로 전달하고 다시 데이터노드로부터 결과를 취합하는 노드.<br>

노드들은 역할을 서로 겸할 수 있다. 다만 그럴수록 해당 노드의 부하가 커진다는 점을 유념해야한다. 가령 코디네이트 전용 노드를 둔다면 그 노드는 코디네이트 역할만 전담하기 때문에 전체 클러스터에서 코디네이트 역할의 부하가 줄어들어 전체 클러스터의 부하를 줄일 수 있다. <br>

엘라스틱서치는 인덱스별로 프라이머리 샤드 갯수를 사전에 지정할 수 있다. 여기서 <br>
프라이머리샤드: 문서가 실제로 저장되는 샤드 <br>
레플리카샤드: 검색은 되지만 문서가 저장되지는 않는, 프라이머리샤드의 백업샤드. 다만 프라이머리샤드가 작동불가할때 레플리카 샤드중 하나가 프라이머리샤드로 승격된다. <br>
이다. <br>
주의할 점은, 프라이머리 샤드는 인덱스를 한번 생성할 때 설정한 값을 이후 변경이 불가하다는 점이다. 그러나 레플리카샤드의 갯수는 인덱스 생성 후에도 조정할 수 있다.<br>

10개의 데이터노드가 있다고 치고 '초콜릿'인덱스의 프라이머리샤드 갯수가 12개, '신발'인덱스의 프라이머리샤드 갯수가 17개라 치면 이 프라이머리 샤드들, 그리고 프라이머리 샤드 * 레플리카샤드 사용갯수 개에 해당하는 레플리카샤드들은 10개의 데이터노드들에 고루고루 분산된다.<br>
그리고 인덱스에 저장되는 문서들은 Hash(문서의 ID) % 해당 인덱스의 프라이머리 샤드 갯수 의 함수에 따라 여러 노드들에 분산저장된다. 즉 한 인덱스 전체를 검색하면 빠른시간내에 모든 노드들을 뒤지게 된다. 노드별로 저장하고 있는 문서들이 다르기 때문이다. 즉 여러노드로부터 문서들을 취합해야 하나의 전체 인덱스를 조회할 수 있다. 이 과정에서 특정 노드가 고장나도 문서가 유실되지 않는 이유는 그 문서가 속한 레플리카 샤드는 다른 노드에 존재하기 때문이다. 극단적으로 해당 문서가 저장되는 프라이머리 샤드를 보유한 컴퓨터(노드)와 레플리카 샤드를 보유한 노드들이 모두 동시에 고장나지 않는 한 문서는 유실되지 않는다. <br>

샤드는 논리적 개념이고 실제로 물리적인 관점에서 문서는 샤드내 세그먼트라는 디스크 공간에 저장된다. 시간이 지남에 따라 한 노드내의 디스크내에 샤드는 갯수가 많아지게 되고 일부 세그먼트가 지워지고 또 새로 생기는 과정에서 디스크 공간의 비효율이 발생한다. 이를 방지하기 위해 EL은 백그라운드에서 자동으로 세그먼트 병합을 진행해 사용자의 요청에 대한 응답속도를 높인다. 이때 세그먼트 병합은 백그라운드에서 자동으로 진행되나 forceMerge같은 API로 강제 실행 시킬 수도 있다.<br>

ElasticSearch의 매핑은 RDBMS의 스키마와 유사하다. 매핑정보는 각 인덱스마다 메타정보로 저장되며 이는 인덱스명/_mapping API를 통해 조회해볼 수 있다. 여기서 인덱스의 매핑 결과의 가장 첫번째 키값는 인덱스의 타입이다. EL은 한 인덱스당 하나의 타입만 지원하기 떄문에 관례샹 _doc로 많이 쓴다. RDBMS의 테이블과 유사한 개념인데, 즉 EL은 한 데이터베이스(인덱스)당 한 테이블(타입)만 지원한다고 이해하면 쉽다.<br>

타입 아래에는 properties 라는 키를 통해 이 타입에 존재하는 프로퍼티 각각에 대해 볼 수 있다. 주로 해당 프로퍼티가 취하는 타입종류를 볼 수 있다. 이 타입은 정적으로 혹은 처음 들어온 문서의 성격에 따라 동적으로 정해지며 한 번 정해진 이후로는 이 규격에 맞지 않는 문서가 들어올 시 오류를 발생시킨다.<br>
